
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Deployment Â· Haystack Documentation</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-forkmegithub/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-disqus/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="sub_systems.html" />
    
    
    <link rel="prev" href="../clients.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../getting_started.html">
            
                <a href="../getting_started.html">
            
                    
                    Getting Started
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../architecture.html">
            
                <a href="../architecture.html">
            
                    
                    Architecture
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../subsystems/subsystems.html">
            
                <a href="../subsystems/subsystems.html">
            
                    
                    Subsystems
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../subsystems/traces.html">
            
                <a href="../subsystems/traces.html">
            
                    
                    Traces
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../subsystems/trends.html">
            
                <a href="../subsystems/trends.html">
            
                    
                    Trends
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../subsystems/collectors.html">
            
                <a href="../subsystems/collectors.html">
            
                    
                    Collectors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../subsystems/pipes.html">
            
                <a href="../subsystems/pipes.html">
            
                    
                    Pipes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../subsystems/dependencies.html">
            
                <a href="../subsystems/dependencies.html">
            
                    
                    Dependencies
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../subsystems/anomaly_detection.html">
            
                <a href="../subsystems/anomaly_detection.html">
            
                    
                    Anomaly Detection
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../ui/ui.html">
            
                <a href="../ui/ui.html">
            
                    
                    UI
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../ui/traces.html">
            
                <a href="../ui/traces.html">
            
                    
                    Traces View
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../ui/trends.html">
            
                <a href="../ui/trends.html">
            
                    
                    Trends View
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../ui/alerts.html">
            
                <a href="../ui/alerts.html">
            
                    
                    Alerts View
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../clients.html">
            
                <a href="../clients.html">
            
                    
                    Clients
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.7" data-path="deployment.html">
            
                <a href="deployment.html">
            
                    
                    Deployment
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="sub_systems.html">
            
                <a href="sub_systems.html">
            
                    
                    Subsystems
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="clients.html">
            
                <a href="clients.html">
            
                    
                    Clients
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../contributing.html">
            
                <a href="../contributing.html">
            
                    
                    Contributing
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Deployment</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="deployment">Deployment</h1>
<p>Haystack uses terraform to automates deployment of Haystack components using <a href="https://en.wikipedia.org/wiki/Kubernetes" target="_blank">Kubernetes</a> and <a href="https://aws.amazon.com/" target="_blank">aws</a>. You can use this module to setup haystack cluster on your local(Mac/Linux Machine) or on AWS.</p>
<h2 id="local-cluster">Local Cluster</h2>
<p>To get a feel of haystack you can run haystack locally inside minikube.</p>
<h4 id="pre-requisite">Pre-requisite</h4>
<p>Install <a href="https://kubernetes.io/docs/tasks/tools/install-minikube/" target="_blank">minikube</a> on your box and make sure it is running <code>minikube start</code>.</p>
<h4 id="start">Start</h4>
<p>From the root of the location to which haystack has been cloned:</p>
<pre><code>cd deployment/terraform
./apply-compose.sh -a install
</code></pre><p>this will install required third party software, start the minikube and install all haystack components in dev mode.</p>
<h4 id="verify">Verify</h4>
<pre><code> echo &quot;$(minikube ip) haystack.local&quot; | sudo tee -a /etc/hosts
</code></pre><p>Once you have cname record to minikube, access traefik dashboard at</p>
<pre><code> https://haystack.local:32300
</code></pre><p>Run the following command to see all the kubernetes pods which are deployed -</p>
<pre><code>kubectl get pods --namespace=haystack-apps
</code></pre><h4 id="stop">Stop</h4>
<p>From the root of the location to which haystack has been cloned:</p>
<pre><code>cd deployment/terraform
./apply-compose.sh -a uninstall
</code></pre><p>this will uninstall all haystack components, but will leave minikube running. To bring down minikube:</p>
<pre><code>minikube stop
</code></pre><p>Taking down minikube before running <code>./apply-compose.sh -a install</code> may prove helpful if minikube is returning errors
during the install process. If you choose to take down minikube, you should delete the tfstate files by running, from 
the directory containing apply-compose.sh, the following command:</p>
<pre><code>find . -name &quot;*tfstate*&quot; -exec rm {} \;
</code></pre><p>This command removes the files that Terraform uses to <a href="https://www.terraform.io/docs/state/" target="_blank">keep track of state.</a></p>
<h2 id="aws-cluster">AWS Cluster</h2>
<p>We support out of the box deployment in aws for haystack. The script uses terraform to create a kubernetes cluster and the rest of the dependent-infrastructure for haystack in aws in a single zone at the moment.
Here are the list of components we install : </p>
<ol>
<li>Kubernetes cluster - version 1.8 (using kops)</li>
<li>Apache Cassandra</li>
<li>AWS Elastic Search</li>
<li>Apache Kafka</li>
<li>Kubernetes Addons (Traefik, Fluentd, ElasticSearch, Kibbana, Heapster, Influxdb, Graphite)</li>
<li>Haystack apps inside kubernetes clusters</li>
</ol>
<h4 id="pre-requisite">Pre-requisite</h4>
<p>Haystack-AWS deployment requires you to create the following resources in aws and pass it as a parameter before you can trigger a deploy -</p>
<ol>
<li>AWS VPC</li>
<li>AWS Subnet</li>
<li>Hosted Zone Id</li>
<li>S3 Bucket</li>
<li>IAM User
Make sure the machine where you are running this script has sufficient permissions in AWS to create/manage above mentioned resources.</li>
</ol>
<h4 id="start">Start</h4>
<p>From the root of the location to which haystack has been cloned:</p>
<pre><code>cd deployment/terraform
./apply-compose.sh -a install - c aws -sb &lt;s3_bucket_name&gt;
</code></pre><p>We install required third party software, and terraform opens up an interactive console to suggest the components its going to create in AWS</p>
<h4 id="verify">Verify</h4>
<p>We create an AWS Route53 entry with your <haystack-cluster-name>.<hosted_domain_name>. You can access haystack at -</hosted_domain_name></haystack-cluster-name></p>
<pre><code> http://&lt;haystack-cluster-name&gt;.&lt;hosted_domain_name&gt;
</code></pre><p>To check the health of the k8s cluster you can use grafana at -</p>
<pre><code> http://&lt;haystack-cluster-name&gt;-metrics.&lt;hosted_domain_name&gt;
</code></pre><p>To check the logs of the k8s cluster you can use kibana at -</p>
<pre><code> http://&lt;haystack-cluster-name&gt;-logs.&lt;hosted_domain_name&gt;
</code></pre><p>To see the apps running in the kubernetes cluster you can use the kubernetes dashboard at -</p>
<pre><code> http://&lt;haystack-cluster-name&gt;-k8s.&lt;hosted_domain_name&gt;
</code></pre><p>To see components deployed in kuberenets -</p>
<pre><code>kubectl config use-context haystack-k8s.&lt;hosted_domain_name&gt;
kubectl get pods --namespace=haystack-apps
</code></pre><h4 id="update">Update</h4>
<p>Our terraform deployments are declarative. Thus, updation(eg. to deploy a new version of any haystack-app or increase number of instances in kubernetes cluster), uses the same command as create. After making changes in your terraform configs for updating cluster, run: </p>
<pre><code>cd deployment/terraform
./apply-compose.sh -a install - c aws
</code></pre><p>This will apply only the delta on existing cluster, without affect the existing components.</p>
<h4 id="stop">Stop</h4>
<p>To teardown your AWS cluster, from the root of the location to which haystack has been cloned run:</p>
<pre><code>cd deployment/terraform
./apply-compose.sh -a -c aws uninstall
</code></pre><p>this will uninstall all haystack components, along with the infrastructure created in aws</p>
<div class="gitbook-share"></div>


                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../clients.html" class="navigation navigation-prev " aria-label="Previous page: Clients">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="sub_systems.html" class="navigation navigation-next " aria-label="Next page: Subsystems">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Deployment","level":"1.7","depth":1,"next":{"title":"Subsystems","level":"1.7.1","depth":2,"path":"deployment/sub_systems.md","ref":"deployment/sub_systems.md","articles":[]},"previous":{"title":"Clients","level":"1.6","depth":1,"path":"clients.md","ref":"clients.md","articles":[]},"dir":"ltr"},"config":{"plugins":["share","edit-link","github","forkmegithub","disqus"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"disqus":{"useIdentifier":false,"shortName":"haystack-2"},"github":{"url":"https://github.com/ExpediaDotCom/haystack"},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"edit-link":{"label":"Edit This Page","base":"https://github.com/ExpediaDotCom/haystack/tree/master/docs"},"forkmegithub":{"color":"darkblue","url":"https://github.com/ExpediaDotCom/haystack"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"share":{}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Haystack Documentation","gitbook":"3.2.3"},"file":{"path":"deployment/deployment.md","mtime":"2018-03-27T11:47:14.414Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-03-27T11:48:11.878Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-share/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-edit-link/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-forkmegithub/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-disqus/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

