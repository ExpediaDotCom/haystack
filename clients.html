
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Clients Â· Haystack Documentation</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-forkmegithub/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-disqus/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="deployment/deployment.html" />
    
    
    <link rel="prev" href="ui/alerts.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="getting_started.html">
            
                <a href="getting_started.html">
            
                    
                    Getting Started
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="architecture.html">
            
                <a href="architecture.html">
            
                    
                    Architecture
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="subsystems/subsystems.html">
            
                <a href="subsystems/subsystems.html">
            
                    
                    Subsystems
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="subsystems/traces.html">
            
                <a href="subsystems/traces.html">
            
                    
                    Traces
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="subsystems/trends.html">
            
                <a href="subsystems/trends.html">
            
                    
                    Trends
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="subsystems/collectors.html">
            
                <a href="subsystems/collectors.html">
            
                    
                    Collectors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="subsystems/pipes.html">
            
                <a href="subsystems/pipes.html">
            
                    
                    Pipes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="subsystems/dependencies.html">
            
                <a href="subsystems/dependencies.html">
            
                    
                    Dependencies
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="subsystems/anomaly_detection.html">
            
                <a href="subsystems/anomaly_detection.html">
            
                    
                    Anomaly Detection
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="ui/ui.html">
            
                <a href="ui/ui.html">
            
                    
                    UI
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="ui/traces.html">
            
                <a href="ui/traces.html">
            
                    
                    Traces View
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="ui/trends.html">
            
                <a href="ui/trends.html">
            
                    
                    Trends View
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="ui/alerts.html">
            
                <a href="ui/alerts.html">
            
                    
                    Alerts View
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter active" data-level="1.6" data-path="clients.html">
            
                <a href="clients.html">
            
                    
                    Clients
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="deployment/deployment.html">
            
                <a href="deployment/deployment.html">
            
                    
                    Deployment
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="deployment/sub_systems.html">
            
                <a href="deployment/sub_systems.html">
            
                    
                    Subsystems
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="deployment/clients.html">
            
                <a href="deployment/clients.html">
            
                    
                    Clients
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="contributing.html">
            
                <a href="contributing.html">
            
                    
                    Contributing
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Clients</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="haystack-client">Haystack Client</h1>
<h2 id="why-opentracing">Why OpenTracing?</h2>
<p>Instrumenting a system for tracing has long been a labor-intensive and complicated task. Tracing brings the benefits of visibility into an application as it grows in number of processes, starts seeing increased concurrency, or non-trivial interactions between mobile/web clients and servers. But setting up instrumentation and deciding which tracer to use can add up to a large project. The OpenTracing standard changes that, making it possible to instrument applications for distributed tracing with minimal effort providing standardization across the globe.</p>
<h2 id="architecture">Architecture</h2>
<h1 id="haystack-agent">Haystack Agent</h1>
<h2 id="why-agent">Why Agent?</h2>
<p>For pull based model, refer to <a href="https://expediadotcom.github.io/haystack/subsystems/collectors.html" target="_blank">Collectors</a>.</p>
<h2 id="what-is-haystack-agent">What is Haystack Agent?</h2>
<p>This repo contains haystack-agent that can be run as a side-car container or a standalone agent on the same host of micro service application. One need to add the haystack <a href="https://github.com/ExpediaDotCom/haystack-client-java" target="_blank">client library</a> in the application to push the <a href="https://github.com/ExpediaDotCom/haystack-idl" target="_blank">spans</a> to this agent running locally(or a side car container).</p>
<p>The haystack span-agent runs as a grpc server that accepts the spans. It collects the spans and dispatch them to one or more sinks e.g. kafka, aws kinesis etc. depending upon the configuration.</p>
<p>We provide couple of dispatchers out of the box for e.g kafka and aws kinesis. We strongly encourage open source community to contribute dispatchers in this repo. However one is free to use these agent libraries published in maven central to write custom agents or dispatchers in a private repo.</p>
<h2 id="architecture">Architecture</h2>
<p>The haystack-agent uses the <a href="https://docs.oracle.com/javase/tutorial/ext/basics/spi.html" target="_blank">SPI</a> design architecture. The fat jar that gets built of this code contains single agent providers with two dispatchers (kinesis and kafka) discussed in more detail below. However design allows to add more agent and dispatcher providers. The agents are loaded depending upon the configuration that can be provided via a http endpoint or a local file like</p>
<p>java -jar target/haystack-agent.jar --config-provider file --file-path docker/dev-config.yaml
The main method in AgentLoader class loads and initializes the agents using ServiceLoader.load(). Each agent further loads the configured dispatchers using the same ServiceLoader.load() mechanism and everything is controlled through configuration.</p>
<h3 id="haystack-agent-configuration">Haystack Agent Configuration</h3>
<p>The configuration readers are also implemented using the SPI design model. For now, we are only using file config provider that is implemented <a href="https://github.com/ExpediaDotCom/haystack-agent/tree/master/config-providers/file" target="_blank">here</a>.</p>
<p>Following is an example configuration that loads a single agent providers that reads the spans(proto) over grpc. This span agent spins up a grpc server listening on different ports 34000 and publish them to kinesis and kafka as per configuration below.</p>
<p>The app or microservice need to use a grpc client to send messages to this haystack-agent.</p>
<p>agents:</p>
<ul>
<li>name: &quot;spans&quot;
props:
  port: 34000
dispatchers:
  kinesis:<pre><code>Region: us-west-2
StreamName: spans
OutstandingRecordsLimit: 10000
MetricsLevel: none
</code></pre>  kafka:<pre><code>bootstrap.servers: kafka-svc:9092
producer.topic: spans
</code></pre></li>
</ul>
<h2 id="agent-providers">Agent Providers</h2>
<p>We have one agent provider today that is loaded depending upon the configuration as above.</p>
<h3 id="span-proto-agent">Span Proto Agent</h3>
<p>This agent listens as a grpc server on a configurable port and accepts the <a href="https://github.com/ExpediaDotCom/haystack-idl/tree/master/proto/agent" target="_blank">span proto</a> from the clients. The span agent is already implemented in the open source repo and it supports both kinesis and kafka dispatchers. Please note we only bundle this span-agent and kinesis dispatcher in our fat jar.</p>
<h2 id="dispatchers">Dispatchers</h2>
<h3 id="kinesis-dispatcher">Kinesis Dispatcher</h3>
<p>Kinesis dispatcher uses <a href="https://github.com/awslabs/amazon-kinesis-producer" target="_blank">KPL</a> and we require following mandatory configuration properties for it to work.</p>
<p>a. Region - aws region for e.g. us-west-2
b. StreamName - name of kinesis stream where spans will be published
c. OutstandingRecordsLimit - maximum pending records that are still not published to kinesis. If agent receives more dispatch requests, then it sends back &apos;RATE_LIMIT_ERROR&apos; in grpc response.</p>
<p>You need to provide AWS_ACCESS_KEY and AWS_SECRET_KEY as java system property or environment variable or use the IAM role for connecting to Kinesis.
Kinesis dispatcher can be configured with other <a href="https://github.com/awslabs/amazon-kinesis-producer/blob/master/java/amazon-kinesis-producer-sample/default_config.properties" target="_blank">KPL properties</a> in the same way as we do with &apos;Region&apos;</p>
<h3 id="kafka-dispatcher">Kafka Dispatcher</h3>
<p>Kafka dispatcher uses high level kafka producer to write the spans to kafka topic. The dispatcher expects a partition key and the span-agent uses the <a href="https://github.com/ExpediaDotCom/haystack-idl/blob/master/proto/span.proto" target="_blank">TraceId</a> in span proto object for the same.</p>
<p>a. producer.topic - kafka topic
b. bootstrap.servers - set of bootstrap servers</p>
<p>Kafka dispatcher can be configured with other kafka producer properties in the same way as we do with bootstrap.servers.</p>
<div class="gitbook-share"></div>


                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="ui/alerts.html" class="navigation navigation-prev " aria-label="Previous page: Alerts View">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="deployment/deployment.html" class="navigation navigation-next " aria-label="Next page: Deployment">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Clients","level":"1.6","depth":1,"next":{"title":"Deployment","level":"1.7","depth":1,"path":"deployment/deployment.md","ref":"deployment/deployment.md","articles":[{"title":"Subsystems","level":"1.7.1","depth":2,"path":"deployment/sub_systems.md","ref":"deployment/sub_systems.md","articles":[]},{"title":"Clients","level":"1.7.2","depth":2,"path":"deployment/clients.md","ref":"deployment/clients.md","articles":[]}]},"previous":{"title":"Alerts View","level":"1.5.3","depth":2,"path":"ui/alerts.md","ref":"ui/alerts.md","articles":[]},"dir":"ltr"},"config":{"plugins":["share","edit-link","github","forkmegithub","disqus"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"disqus":{"useIdentifier":false,"shortName":"haystack-2"},"github":{"url":"https://github.com/ExpediaDotCom/haystack"},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"edit-link":{"label":"Edit This Page","base":"https://github.com/ExpediaDotCom/haystack/tree/master/docs"},"forkmegithub":{"color":"darkblue","url":"https://github.com/ExpediaDotCom/haystack"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"share":{}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Haystack Documentation","gitbook":"3.2.3"},"file":{"path":"clients.md","mtime":"2018-03-27T11:47:14.414Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-03-27T11:48:11.878Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-share/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-edit-link/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-forkmegithub/plugin.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-disqus/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

